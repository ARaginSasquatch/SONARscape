<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SONARScape: Radio Operator Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/react@16.14.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@16.14.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@6.26.0/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body className="bg-gray-800 text-white">
  <div id="root"></div>
  <script type="text/babel">
    const { useState } = React;

    // Updated islands array as provided
    const islands = [
      { x: 2, y: 1 }, { x: 2, y: 2 }, { x: 6, y: 1 }, { x: 8, y: 2 }, { x: 8, y: 3 }, { x: 12, y: 2 }, { x: 12, y: 1 }, { x: 13, y: 1 }, { x: 11, y: 11 }, { x: 12, y: 12 }, { x: 13, y: 13 }, { x: 11, y: 8 }, { x: 12, y: 8 }, { x: 13, y: 8 }, { x: 6, y: 6 }, { x: 6, y: 7 }, { x: 7, y: 8 }, { x: 8, y: 6 }, { x: 7, y: 11 }, { x: 6, y: 13 }, { x: 8, y: 13 }, { x: 3, y: 10 }, { x: 2, y: 11 }, { x: 2, y: 13 }, { x: 3, y: 14 }, { x: 0, y: 12 }, { x: 1, y: 6 }, { x: 1, y: 7 }, { x: 1, y: 8 }, { x: 3, y: 6 }, { x: 3, y: 7 }, { x: 3, y: 8 }
    ];

    // Radio Operator Interface
    const RadioOperatorInterface = () => {
      const gridSize = 15;
      const [overlayPos, setOverlayPos] = useState({ x: -150, y: -150 });
      const [isDragging, setIsDragging] = useState(false);
      const [currentPos, setCurrentPos] = useState({ x: 7, y: 7 });
      const [markedTiles, setMarkedTiles] = useState([{ x: 7, y: 7 }]);
      const [enemyMoves, setEnemyMoves] = useState([]);
      const [sectorGuess, setSectorGuess] = useState('');
      const [selectedIslands, setSelectedIslands] = useState([]); // State for selected islands

      console.log('RadioOperatorInterface rendering');

      const addMove = (move) => {
        let newX = currentPos.x;
        let newY = currentPos.y;
        if (move === 'North') newY--;
        else if (move === 'South') newY++;
        else if (move === 'East') newX++;
        else if (move === 'West') newX--;
        if (newX >= 0 && newX < gridSize && newY >= 0 && newY < gridSize) {
          setCurrentPos({ x: newX, y: newY });
          setMarkedTiles(prev => [...prev, { x: newX, y: newY }]);
          setEnemyMoves(prev => [...prev, move]);
        } else {
          alert('Move out of bounds!');
        }
      };

      const guessSector = () => {
        if (sectorGuess >= 1 && sectorGuess <= 9) {
          alert(`Guessed sector ${sectorGuess}! (No enemy to track in single dashboard mode)`);
          setSectorGuess('');
        } else {
          alert('Invalid sector!');
        }
      };

      const handleMouseDown = () => {
        setIsDragging(true);
      };

      const handleMouseUp = () => {
        setIsDragging(false);
      };

      const handleMouseMove = (e) => {
        e.persist();
        if (isDragging) {
          setOverlayPos(prev => ({
            x: prev.x + e.movementX,
            y: prev.y + e.movementY
          }));
        }
      };

      const handleCellClick = (x, y) => {
        const isAlreadySelected = selectedIslands.some(i => i.x === x && i.y === y);
        if (isAlreadySelected) {
          // Deselect the cell if already selected
          setSelectedIslands(prev => prev.filter(i => !(i.x === x && i.y === y)));
        } else {
          // Add the cell to selected islands
          setSelectedIslands(prev => [...prev, { x, y }]);
        }
      };

      const clearSelection = () => {
        setSelectedIslands([]);
      };

      const renderMap = () => {
        console.log(`renderMap: Generating grid - gridSize: ${gridSize}x${gridSize}`);
        const grid = [];
        for (let y = 0; y < gridSize; y++) {
          const row = [];
          for (let x = 0; x < gridSize; x++) {
            const isIsland = islands.some(i => i.x === x && i.y === y);
            const isSelected = selectedIslands.some(i => i.x === x && i.y === y);
            const sectorX = Math.floor(x / 5) * 5;
            const sectorY = Math.floor(y / 5) * 5;
            const sectorNum = Math.floor(y / 5) * 3 + Math.floor(x / 5) + 1;
            const isSectorCenter = x === sectorX + 2 && y === sectorY + 2 && !isIsland;
            const isOrigin = x === 0 && y === 0;

            // Determine thicker borders for sector boundaries
            const thickLeft = x % 5 === 0 ? 'border-l-2 border-l-gray-400' : '';
            const thickRight = (x + 1) % 5 === 0 ? 'border-r-2 border-r-gray-400' : '';
            const thickTop = y % 5 === 0 ? 'border-t-2 border-t-gray-400' : '';
            const thickBottom = (y + 1) % 5 === 0 ? 'border-b-2 border-b-gray-400' : '';

            if (isIsland) {
              console.log(`renderMap: Island found at (${x}, ${y})`);
            }
            if (isOrigin) {
              console.log('renderMap: Marking origin at (0,0)');
            }
            row.push(
              <div
                key={`${x}-${y}`}
                onClick={() => handleCellClick(x, y)}
                className={`w-5 h-5 flex items-center justify-center text-xs border border-gray-600 border-opacity-50 ${thickLeft} ${thickRight} ${thickTop} ${thickBottom} cursor-pointer ${
                  isOrigin ? 'bg-purple-600' : isSelected ? 'bg-orange-500' : isIsland ? 'bg-green-600' : 'bg-blue-200'
                }`}
              >
                {isOrigin ? 'üåü' : isIsland ? 'üèùÔ∏è' : isSectorCenter ? sectorNum : ''}
              </div>
            );
          }
          grid.push(<div key={y} className="flex">{row}</div>);
        }
        return grid;
      };

      const renderOverlay = () => {
        const grid = [];
        for (let y = 0; y < gridSize; y++) {
          const row = [];
          for (let x = 0; x < gridSize; x++) {
            const isMarked = markedTiles.some(m => m.x === x && m.y === y);
            const isCurrent = x === currentPos.x && y === currentPos.y;

            // Determine thicker borders for sector boundaries
            const thickLeft = x % 5 === 0 ? 'border-l-2 border-l-gray-300' : '';
            const thickRight = (x + 1) % 5 === 0 ? 'border-r-2 border-r-gray-300' : '';
            const thickTop = y % 5 === 0 ? 'border-t-2 border-t-gray-300' : '';
            const thickBottom = (y + 1) % 5 === 0 ? 'border-b-2 border-b-gray-300' : '';

            row.push(
              <div
                key={`${x}-${y}`}
                className={`w-5 h-5 border border-gray-500 border-opacity-50 ${thickLeft} ${thickRight} ${thickTop} ${thickBottom} ${
                  isCurrent ? 'bg-yellow-600' : isMarked ? 'bg-yellow-400' : 'bg-transparent'
                } opacity-50 flex items-center justify-center`}
              >
                {isCurrent ? 'üìç' : isMarked ? '¬∑' : ''}
              </div>
            );
          }
          grid.push(<div key={y} className="flex">{row}</div>);
        }
        return grid;
      };

      const exportIslands = () => {
        if (selectedIslands.length === 0) {
          return 'No islands selected.';
        }
        const formatted = selectedIslands.map(i => `{ x: ${i.x}, y: ${i.y} }`).join(', ');
        return `const islands = [\n  ${formatted}\n];`;
      };

      return (
        <div className="bg-gray-700 p-4 rounded-lg shadow-lg">
          <h3 className="text-lg font-bold mb-2">Radio Operator</h3>
          <p className="text-sm mb-2">Click on the map to select/deselect island positions (orange). Export them below.</p>
          <div className="relative mb-4" style={{ width: '300px', height: '300px' }}>
            <div className="absolute">{renderMap()}</div>
            <div
              className="absolute"
              style={{ transform: `translate(${overlayPos.x}px, ${overlayPos.y}px)`, cursor: isDragging ? 'grabbing' : 'grab' }}
              onMouseDown={handleMouseDown}
              onMouseUp={handleMouseUp}
              onMouseMove={handleMouseMove}
            >
              {renderOverlay()}
            </div>
          </div>
          <div className="bg-gray-800 p-2 rounded h-40 overflow-y-auto mb-2">
            {enemyMoves.map((move, index) => (
              <p key={index} className="text-sm">{move}</p>
            ))}
          </div>
          <div className="flex space-x-2 mb-2">
            <button onClick={() => addMove('North')} className="p-2 bg-blue-600 rounded hover:bg-blue-700">N</button>
            <button onClick={() => addMove('South')} className="p-2 bg-blue-600 rounded hover:bg-blue-700">S</button>
            <button onClick={() => addMove('East')} className="p-2 bg-blue-600 rounded hover:bg-blue-700">E</button>
            <button onClick={() => addMove('West')} className="p-2 bg-blue-600 rounded hover:bg-blue-700">W</button>
          </div>
          <div className="flex mb-2">
            <input
              type="number"
              value={sectorGuess}
              onChange={(e) => setSectorGuess(e.target.value)}
              className="p-2 bg-gray-600 rounded-l text-white w-20"
              placeholder="Sector (1-9)"
            />
            <button
              onClick={guessSector}
              className="p-2 bg-blue-600 rounded-r hover:bg-blue-700"
            >
              Guess Sector
            </button>
          </div>
          <div className="mb-2">
            <h4 className="text-md font-bold mb-1">Selected Island Coordinates</h4>
            <pre className="bg-gray-800 p-2 rounded text-sm overflow-x-auto">
              {exportIslands()}
            </pre>
          </div>
          <button
            onClick={clearSelection}
            className="p-2 bg-red-600 rounded hover:bg-red-700"
          >
            Clear Selection
          </button>
        </div>
      );
    };

    // Sidebar Component
    const Sidebar = ({ toggleSidebar, isOpen }) => {
      const simplifiedCode = `
const islands = [
  { x: 2, y: 1 }, { x: 2, y: 2 }, { x: 6, y: 1 }, { x: 8, y: 2 }, { x: 8, y: 3 },
  { x: 12, y: 2 }, { x: 12, y: 1 }, { x: 13, y: 1 }, { x: 11, y: 11 }, { x: 12, y: 12 },
  // ... (full array in main code)
];
      `.trim();

      return (
        <div
          className={`fixed top-0 left-0 h-full bg-gray-900 text-white w-64 transform ${
            isOpen ? 'translate-x-0' : '-translate-x-full'
          } transition-transform duration-300 ease-in-out z-50 md:translate-x-0 md:static md:w-64`}
        >
          <div className="p-4 flex justify-between items-center">
            <h2 className="text-xl font-bold">SONARScape</h2>
            <button onClick={toggleSidebar} className="md:hidden text-white">
              ‚úï
            </button>
          </div>
          <nav className="p-4">
            <ul className="space-y-2">
              <li>
                <a href="#radio-operator" className="block p-2 rounded hover:bg-gray-700">Radio Operator</a>
              </li>
            </ul>
          </nav>
          <div className="p-4">
            <h3 className="text-lg font-bold mb-2">Island Positions</h3>
            <pre className="bg-gray-800 p-2 rounded text-sm overflow-auto h-96">
              {simplifiedCode}
            </pre>
          </div>
        </div>
      );
    };

    // Dashboard
    const Dashboard = () => {
      const [isSidebarOpen, setIsSidebarOpen] = useState(false);

      const toggleSidebar = () => {
        setIsSidebarOpen(!isSidebarOpen);
      };

      console.log('Dashboard rendering');

      return (
        <div className="flex min-h-screen">
          <Sidebar toggleSidebar={toggleSidebar} isOpen={isSidebarOpen} />
          <div className="flex-1">
            <div className="p-6 bg-gray-800 min-h-screen">
              <div className="flex justify-between items-center mb-4">
                <h1 className="text-2xl font-bold">SONARScape: Radio Operator</h1>
                <button onClick={toggleSidebar} className="md:hidden text-white">
                  ‚ò∞
                </button>
              </div>
              <div className="grid grid-cols-1 gap-4">
                <div id="radio-operator">
                  <RadioOperatorInterface />
                </div>
              </div>
            </div>
          </div>
          {isSidebarOpen && (
            <div
              className="fixed inset-0 bg-black opacity-50 md:hidden"
              onClick={toggleSidebar}
            ></div>
          )}
        </div>
      );
    };

    // Error Boundary
    class ErrorBoundary extends React.Component {
      state = { hasError: false };

      static getDerivedStateFromError(error) {
        console.log('ErrorBoundary caught error:', error);
        return { hasError: true };
      }

      render() {
        if (this.state.hasError) {
          return <h1 className="text-red-600">Something went wrong. Check console for details.</h1>;
        }
        return this.props.children;
      }
    }

    // Main App
    const App = () => {
      console.log('Rendering App component');
      return (
        <ErrorBoundary>
          <Dashboard />
        </ErrorBoundary>
      );
    };

    // Check if scripts loaded correctly
    if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {
      console.error('Failed to load React or ReactDOM. Please check your network connection and script sources.');
      document.getElementById('root').innerHTML = '<h1 className="text-red-600">Failed to load the app. Please check the console for details.</h1>';
    } else {
      ReactDOM.render(<App />, document.getElementById('root'));
      console.log('App rendered successfully');
    }
  </script>
</body>
</html>
